# System Patterns

Этот файл документирует повторяющиеся паттерны и стандарты, используемые в проекте.
2026-01-14 18:50:56 - Последняя редакция базового описания.

## Правила редактирования

* Обновлять, когда вводятся новые архитектурные паттерны или изменяются существующие.
* Всегда включать временную метку в формате [ГГГГ-ММ-ДД ЧЧ:ММ:СС] - [Описание паттерна/изменения].
* Записи в разделах должны быть отсортированы в обратном хронологическом порядке (самые новые сверху, старые внизу).
* Разделы должны быть отсортированы по важности: Паттерны кодирования, Архитектурные паттерны, Паттерны тестирования.
2026-01-14 18:50:56 - Последняя редакция правил редактирования.

## Паттерны кодирования

2026-01-14 18:50:56 - Обновление паттернов кодирования на основе анализа кода проекта Stellar Scrypt.
* **Структура функций**: Функции начинаются с комментариев и описания назначения. Внутренние хелперы имеют суффикс `_` (например, `loadConsts_`, `getOrCreateSheet_`).
* **Переменные**: Использование `const` для неизменяемых переменных, `let` для изменяемых. Избегание `var`.
* **Обработка ошибок**: Использование `try-catch` для асинхронных вызовов API, логирование ошибок в отдельные листы (например, ASSETS_ERRORS).
* **Форматирование кода**: Консистентные отступы (2 пробела), использование template literals для строк с переменными.
* **Комментарии**: Использование многострочных комментариев `/* ========================= ... ========================= */` для разделения секций кода.
* **API взаимодействия**: Работа с Google Sheets API (`SpreadsheetApp`), UrlFetchApp для HTTP запросов, PropertiesService для хранения курсоров.

## Архитектурные паттерны

2026-01-14 18:50:56 - Определение архитектурных паттернов проекта Stellar Scrypt.
* **Модульная архитектура**: Код разделен на модули по функциональности (синхронизация активов, переводов, история активов). Каждая функция отвечает за конкретную задачу.
* **Пагинация с курсорами**: Использование курсоров Stellar Horizon API для обработки больших объемов данных. Курсоры сохраняются в PropertiesService для продолжения синхронизации.
* **Фильтрация данных**: Многоуровневая фильтрация: по типам операций (только payments), по участникам (фонды и резиденты), по активам (разрешенные активы из списка резидентов).
* **Отладка и аудит**: Создание отдельных листов для отладки (ASSETS_DEBUG, TRANSFERS_DEBUG) и ошибок (ASSETS_ERRORS). Включение сырых данных для анализа.
* **Интеграция с Google Sheets**: Динамическое создание и обновление листов. Использование `getRange().setValues()` для массовой записи данных.
* **Кросс-платформенность**: Код работает в среде Google Apps Script, совместим с различными ОС через абстракцию API.

## Паттерны тестирования

2026-01-14 18:50:56 - Идентификация паттернов тестирования в проекте.
* **Отладочные функции**: Специальные функции для точечной отладки (например, `debugSingleAccountAssets`), позволяющие тестировать отдельные аккаунты.
* **Логирование**: Запись ошибок и отладочной информации в отдельные листы для анализа. Использование `console.log` для промежуточных результатов.
* **Валидация данных**: Проверка наличия обязательных полей (например, `mustGet_` для констант), обработка пустых или некорректных ответов API.
* **Ручное тестирование**: Функции для ручного запуска и проверки результатов в Google Sheets (меню Stellar с пунктами обновления).
* **Защита от бесконечных циклов**: Лимиты на количество страниц (например, 30 страниц) для предотвращения зависаний при тестировании.